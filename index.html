<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Easy road bike fitting</title>
	
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">		
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">	
	<link href="css/style.css" rel='stylesheet' type='text/css' />	
</head>
<body>			
	<div class="container-fluid" style="margin-top: 30px;">		
		<div class="row">
			<div class="col-md-2">				
				<div class="panel panel-default">
					<div class="panel-heading">
						Angles
					</div>
					<div class="panel-body">
						<div class="dropdown btn-group-sm" style="margin-bottom: 5px;">
							<span>Bike type</span>
							<button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-expanded="true">
								Road
								<span class="caret"></span>
							</button>
							<ul class="dropdown-menu dropdown-menu-right" id="bikeTypesList" role="menu" aria-labelledby="dropdownMenu1">							
							</ul>
						</div>

						<span class="angleName">Knee Angle Flexion</span><span class="angleText" id="hipKneeAngle"></span>
						<br>
						<span class="angleName">Elbow Angle </span><span class="angleText" id="armForeArm"></span>
						<br>
						<span class="angleName">Knee Angle Extension </span><span class="angleText" id="kneeExtension"></span>
						<br>
						<span class="angleName">Hip Angle Open </span><span class="angleText" id="hipOpen"></span>
						<br>
						<span class="angleName">Shoulder Angle to Elbow </span><span class="angleText" id="armPit"></span>
						<br>
						<span class="angleName">Back Angle </span><span class="angleText" id="backAngle"></span>

						<div class="alert alert-note alert-small" role="alert" style="margin-top: 5px;">
							<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
							<span class="sr-only">Note:</span>
							Adjust the horizontal reference for correct back angle
						</div>												
					</div>
				</div>

				<div class="panel panel-default">
					<div class="panel-heading">Lengths</div>
					<div class="panel-body">	
						<div id="alertLength" class="alert alert-note alert-small" role="alert">
							<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
							<span class="sr-only">Note:</span>
							Use the length reference to point to something in your picture whose dimensions you know
						</div>
						<span class="angleName">Length of reference </span><input type="text" class="form-control" id="inputLength" style="width: 50px;display: inline;" placeholder="cm">	
						<br>
						<span class="angleName">Thigh Length </span><span class="angleText" id="thighLength"></span>
						<br>
						<span class="angleName">Shin Length </span><span class="angleText" id="shinLength"></span>
						<br>
						<span class="angleName">Hip to wrist (horiz) </span><span class="angleText" id="hipToWristH"></span>
						<br>
						<span class="angleName">Hip to wrist (vertical) </span><span class="angleText" id="hipToWristV"></span>
					</div>
				</div>

				<div class="panel panel-default panel-custom-tool">
					<div class="panel-heading clearfix">
						<span>Custom measurements</span>
						<span class="glyphicon glyphicon-plus pull-right" aria-hidden="true" id="btnAddCustomTool"></span>
					</div>
					<div class="panel-body custom-tool-template" style="display: none;">
						<div class="custom-tool-bg">
							<span class="close remove-custom-tool glyphicon glyphicon-remove"></span>								
							<span class="angleName">Length</span><span class="angleText" id="customLength0"></span>
							<br>
							<span class="angleName">Length</span><span class="angleText" id="customLength1"></span>
							<br>
							<span class="angleName">Angle between </span><span class="angleText" id="customAngle"></span>					
						</div>
					</div>
				</div>
			</div>

			<div class="col-md-8">
				<div class="stepWorkArea alert alert-header" role="alert">											
					
					<span class="btn btn-default btn-file" style="margin: 0 16px 4px 0;">
						Upload a picture or video of you<input type="file" id="fileOne" accept="video/*" class="clickable">
					</span>
					<div class="inline" style="display:none;" id="videoControls">
						<span id="rwd" class="video-control unselectable glyphicon glyphicon-backward"></span>
						<span id="play" class="video-control unselectable glyphicon glyphicon-pause"></span>
						<span id="fwd" class="video-control unselectable glyphicon glyphicon-forward"></span>
						<span>Advance/rewind by: </span>
						<input type="text" class="form-control" id="advanceValue" style="width: 70px;display: inline;" value="0.25">	
					</div>

					<div class="stepCanvasArea" style="width: 100%; height: 100%; pointer-events: none;background-color: #E5FFF7; background-repeat: no-repeat; background-position: center;background-image: url(http://www.triradar.com/files/2014/01/DIY-Bike-Fit.jpg); background-size: contain;">
						<video id="riderVideo" class="video-js vjs-default-skin" style="width: 100%; display: none;" autoplay loop></video>
						<canvas id="stepOneCanvas" style="pointer-events: all; top: 30px; width: 100%; position: absolute;"></canvas>						
					</div>		
				</div>

				<!--div class="stepWorkArea" style="margin-top: 5px;">
					<div class="stepHeader alert alert-header unselectable" role="alert">
						<span id="stepOneDropdownIco" class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>				
						<b>Step 2 </b>| Side picture with knee bent (cranks at 3 and 9 o'clock)
						<span class="btn btn-default btn-file" style="margin-left: 10px;">
							Upload a picture of you<input type="file" id="fileTwo" class="clickable">
						</span>
					</div>		
					<div class="stepCanvasArea" style="width:100%; height: 100%; pointer-events: none;background-color: #E5FFF7; background-repeat: no-repeat; background-position: center;background-image: url(http://www.londoncyclist.co.uk/wp-content/uploads/2013/03/bike-fitting-side-view-of-cyclist.jpg); background-size: contain;">
						<canvas id="stepTwoCanvas" style="pointer-events: all; width: 100%; height: 100%;"></canvas>
					</div>		
				</div-->
			</div>
		</div>
	</div>
	<!--button type="button" class="btn btn-default" id="btnDump">Dump</button-->

	<script src="js/lib/jquery.min.js" type="text/javascript"></script>		
	<script src="js/lib/bootstrap.min.js" type="text/javascript"></script>	
	<script src="js/paper-full.js" type="text/javascript"></script>
	<script src="js/paper-core.js" type="text/javascript"></script>

	<script src="js/jointpoint.js" type="text/javascript"></script>
	<script src="js/line.js" type="text/javascript"></script>
	<script src="js/text.js" type="text/javascript"></script>
	<script src="js/jointsangle.js" type="text/javascript"></script>	
	<script src="js/dependentpoint.js" type="text/javascript"></script>
	<script src="js/scene.js" type="text/javascript"></script>
	<script src="js/vectorutils.js" type="text/javascript"></script>	
	<script src="js/videoplayer.js" type="text/javascript"></script>	

	<script type="text/javascript">
	$(document).on('change', '.btn-file :file', function(evt) {	
		var input = $(this),
		numFiles = input.get(0).files ? input.get(0).files[0] : 1;
		input.trigger('fileselect', [numFiles, evt.target.id]);
	});

	$(document).ready(function() {
		var self = this;

		paper.install(window);

		var lastCustomToolY = 200;
		var lastCustomToolNo = 0;

		self.customToolsList = [];
		self.ranges = {};

		self.points = {};
		self.lines = {};
		self.angles = {};
		self.texts = {};	

		var letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
		var lastLabel = 0;			

		var windowHeight = 0.9 * $(window).height();
		$('.stepCanvasArea').height(windowHeight);		

		self.video = new VideoPlayer('riderVideo');
		self.videoAdvanceValue = 0.25;
		self.video.height(windowHeight);

		self.videoControls = $('#videoControls');

		self.video.onStatusChanged(function (status) {
			console.log('status' + status);
			var playBtn = $('#play');
			playBtn.removeClass('glyphicon-play');
			playBtn.removeClass('glyphicon-pause');

			playBtn.addClass(status['playbackStatus'] == true ? 'glyphicon-play' : 'glyphicon-pause');
		});
		
		self.videoControls.find('#play').click(function (evt) {
			self.video.togglePlayPause();
		});

		self.videoControls.find('#rwd').click(function (evt) {						
			self.video.pause();
			self.video.rewind(-self.videoAdvanceValue);
		});

		self.videoControls.find('#fwd').click(function (evt) {
			self.video.pause();			
			self.video.advance(self.videoAdvanceValue);
		});

		var advanceValue = $('#advanceValue');
		advanceValue.bind("propertychange change click keyup input paste", function(e) { 
			var parsedValue = parseFloat(advanceValue.val());			

			if (parsedValue != NaN) {
				self.videoAdvanceValue = parsedValue !== NaN ? parsedValue : self.videoAdvanceValue;				
			}	
		});

		self.videoControls.hide();

		var inputLength = $('#inputLength');		

		self.refDistanceCM = 0;
		self.refDistanceInPixels = 0;
		self.refDistanceCMPerPixel  = 0;

		$('.btn-file :file').on('fileselect', function(event, numFiles, targetId) {			
			var file = event.target.files[0];
			var type = file.type;

			var imageMimes = ['image/png', 'image/gif', 'image/bmp', 'image/jpg', 'image/jpeg'];
			
			if (imageMimes.indexOf(type) != -1) {
				var file = new FileReader();			
				file.readAsDataURL(event.target.files[0]);

				file.onload = function(evt) {
					self.video.show(false);
					self.videoControls.hide();

					var destination = $(targetId == 'fileOne' ? $('.stepCanvasArea')[0] : $('.stepCanvasArea')[1]);
					destination.css('background-image', 'url("' + evt.target.result + '")');				
				}		

				return;
			}			
			
			if (!window.URL && !window.webkitURL) {
				alert('Your browser is not ' + '<a href="http://caniuse.com/bloburls">supported</a>!', true);
				return;
			}           

			var isOk = self.video.canPlay(type);
			var message = 'Can play type "' + type + '": ' + isOk;			
			
			if (!isOk) { return; }					

			$('.stepCanvasArea').css('background-image', 'none');

			var fileURL = URL.createObjectURL(file);				

			self.video.show(true);	
			self.videoControls.show();		
			self.video.setSource(fileURL);			
		});

$('.stepHeader').click(function(event) {			
	if (event.target.localName == 'input')
		return;

	$.each($('.stepHeader'), function (index, step) {
		var menuIco = $(step).find('#stepOneDropdownIco');			
				//Close
				if (menuIco.hasClass('glyphicon-chevron-down') == true) {
					menuIco.removeClass('glyphicon-chevron-down');
					menuIco.addClass('glyphicon-chevron-right');

					$($(this).siblings()[0]).animate({ height: "toggle", opacity: 0 }, 500, function() {
						$($(step).siblings()[0]).css('opacity', '0');
					});  

				} else { // Open
					menuIco.addClass('glyphicon-chevron-down');
					menuIco.removeClass('glyphicon-chevron-right');

					$($(this).siblings()[0]).animate({ height: "toggle", opacity: 1 }, 500, function() {
						$($(step).siblings()[0]).css('opacity', '1');
					});					
				}
			});
});

$('#btnAddCustomTool').click(function () {
	var getNextLabel = self.getNextLabel;
	var onAngleChanged = self.onAngleChanged;
	var onLineLengthChanged = self.onCustomToolLineChanged;

	var startLabel = getNextLabel();
	var middleLabel = getNextLabel();
	var endLabel = getNextLabel();

	points = [		
	{'x': 49,  'y' : lastCustomToolY,  'scale' : false, 'name' : SceneUtils.KnownPoints.CUST_TOOL_START + lastCustomToolNo, 'label' : startLabel},
	{'x': 140, 'y' : lastCustomToolY,  'scale' : false, 'name' : SceneUtils.KnownPoints.CUST_TOOL_MIDDLE + lastCustomToolNo, 'label' : middleLabel},
	{'x': 230, 'y' : lastCustomToolY + 20,  'scale' : false, 'name' : SceneUtils.KnownPoints.CUST_TOOL_END + lastCustomToolNo, 'label' : endLabel},
	];

	var customToolBase = SceneUtils.KnownLines.CUSTOM_TOOL + '_' + lastCustomToolNo + '_';

	lines = [
	{ 'name' : customToolBase + '0', 'points' : [SceneUtils.KnownPoints.CUST_TOOL_START + lastCustomToolNo, SceneUtils.KnownPoints.CUST_TOOL_MIDDLE + lastCustomToolNo], 'onLineLengthChanged' : onLineLengthChanged},
	{ 'name' : customToolBase + '1', 'points' : [SceneUtils.KnownPoints.CUST_TOOL_MIDDLE + lastCustomToolNo, SceneUtils.KnownPoints.CUST_TOOL_END + lastCustomToolNo], 'onLineLengthChanged' : onLineLengthChanged},
	];

	angles = [
	{ 'name': SceneUtils.KnownAngles.CUSTOM_ANGLE + lastCustomToolNo, 'side_first' : customToolBase + '0', 'side_second' : customToolBase + '1', 'ranges' : [{'range' : [0, 180], 'color' : 'green'}], 'onAngleChanged' : onAngleChanged},
	];

	self.sceneTop.load(points, lines, angles, []);		

	var template = $('.custom-tool-template').clone();
	template.find('#customLength0').attr('id', customToolBase + '0').prev().text(startLabel + '-' + middleLabel +' Length');
	template.find('#customLength1').attr('id', customToolBase + '1').prev().text(middleLabel + '-' + endLabel +' Length');
	template.find('#customAngle').attr('id', SceneUtils.KnownAngles.CUSTOM_ANGLE + lastCustomToolNo);

	template.find('.remove-custom-tool').attr('ctx', customToolBase).removeClass('remove-custom-tool').addClass('remove-custom-tool' + lastCustomToolNo);

	template.removeClass('custom-tool-template');
	template.addClass('custom-tool-' + lastCustomToolNo);

	template.show();
	self.customToolsList.push(customToolBase);

	$('.panel-custom-tool').append(template[0].outerHTML);
	$('.remove-custom-tool' + lastCustomToolNo).click(function() {
		var ctx = $(this).attr('ctx');
		self.customToolsList.splice(self.customToolsList.indexOf(ctx), 1);

		var toolNo = self.getToolIdFromName(ctx);

		var pointIdsToRemove = [SceneUtils.KnownPoints.CUST_TOOL_START + toolNo, SceneUtils.KnownPoints.CUST_TOOL_MIDDLE + toolNo, SceneUtils.KnownPoints.CUST_TOOL_END + toolNo];
		var lineIdsToRemove = [ctx + '0', ctx + '1'];
		var angleIdsToRemove = [SceneUtils.KnownAngles.CUSTOM_ANGLE + toolNo];

		self.sceneTop.unload(pointIdsToRemove, lineIdsToRemove, angleIdsToRemove);

		$(this).parent().parent().detach();
	});

	lastCustomToolY += 40;
	lastCustomToolNo += 1;
});		  

inputLength.data('oldVal', inputLength.val());
inputLength.bind("propertychange change click keyup input paste", function(e) {
	if (inputLength.val() == '') {
		$('#alertLength').fadeIn();
		return;
	}				

	if (inputLength.data('oldVal') != inputLength.val()) {
		$('#alertLength').fadeOut();

		inputLength.data('oldVal', inputLength.val());
		self.refDistanceCM = inputLength.val() != '' ? inputLength.val() : 0;
		self.refDistanceCMPerPixel  = self.refDistanceCM / self.refDistanceInPixels;

		self.updateLineSizes();
	}
});

[inputLength, advanceValue].forEach(function (ctrl) {
	ctrl.keydown(function(event) {
		var allowedKeyCodes = [8, 9, 13, 27, 37, 39, 46];
		if (allowedKeyCodes.indexOf(event.keyCode) != -1 
			|| (event.keyCode == 190 && $(this).val().indexOf('.') == -1)
			|| (event.keyCode == 65 && event.ctrlKey === true) 
			|| (event.keyCode >= 35 && event.keyCode <= 39)) 
			return;			

		if (event.shiftKey || (event.keyCode < 48 || event.keyCode > 57) && (event.keyCode < 96 || event.keyCode > 105 )) {
			event.preventDefault(); 
		}   
	});
});

self.ranges['road'] = [
{'name' : SceneUtils.KnownAngles.ARM_FOREARM, 'ranges': [{'range' : [150, 170], 'color' : 'green'}]},
{'name' : SceneUtils.KnownAngles.HIP_KNEE_ANGLE, 'ranges' : [{'range' : [140, 145], 'color' : 'green'}]},
{'name' : SceneUtils.KnownAngles.KNEE_EXTENSION, 'ranges' : [{'range' : [35, 40], 'color' : 'green'}]},
{'name' : SceneUtils.KnownAngles.ARM_PIT, 'ranges' : [{'range' : [80, 90], 'color' : 'green'}]},
{'name' : SceneUtils.KnownAngles.BACK_ANGLE, 'ranges' : [{'range' : [40, 45], 'color' : 'green'}]},
];

self.ranges['mtb'] = [
{'name' : SceneUtils.KnownAngles.ARM_FOREARM, 'ranges': [{'range' : [150, 170], 'color' : 'green'}]},
{'name' : SceneUtils.KnownAngles.HIP_KNEE_ANGLE, 'ranges' : [{'range' : [140, 145], 'color' : 'green'}]},
{'name' : SceneUtils.KnownAngles.KNEE_EXTENSION, 'ranges' : [{'range' : [35, 40], 'color' : 'green'}]},
{'name' : SceneUtils.KnownAngles.ARM_PIT, 'ranges' : [{'range' : [75, 80], 'color' : 'green'}]},
{'name' : SceneUtils.KnownAngles.BACK_ANGLE, 'ranges' : [{'range' : [45, 50], 'color' : 'green'}]},
];

self.ranges['tt'] = [
{'name' : SceneUtils.KnownAngles.ARM_FOREARM, 'ranges': [{'range' : [90, 100], 'color' : 'green'}]},
{'name' : SceneUtils.KnownAngles.HIP_KNEE_ANGLE, 'ranges' : [{'range' : [138, 143], 'color' : 'green'}]},
{'name' : SceneUtils.KnownAngles.KNEE_EXTENSION, 'ranges' : [{'range' : [37, 42], 'color' : 'green'}]},
{'name' : SceneUtils.KnownAngles.ARM_PIT, 'ranges' : [{'range' : [75, 80], 'color' : 'green'}]},
{'name' : SceneUtils.KnownAngles.BACK_ANGLE, 'ranges' : [{'range' : [20, 22], 'color' : 'green'}]},
];

self.ranges['tri'] = [
{'name' : SceneUtils.KnownAngles.ARM_FOREARM, 'ranges': [{'range' : [90, 100], 'color' : 'green'}]},
{'name' : SceneUtils.KnownAngles.HIP_KNEE_ANGLE, 'ranges' : [{'range' : [138, 143], 'color' : 'green'}]},
{'name' : SceneUtils.KnownAngles.KNEE_EXTENSION, 'ranges' : [{'range' : [37, 42], 'color' : 'green'}]},
{'name' : SceneUtils.KnownAngles.ARM_PIT, 'ranges' : [{'range' : [70, 75], 'color' : 'green'}]},
{'name' : SceneUtils.KnownAngles.BACK_ANGLE, 'ranges' : [{'range' : [22, 25], 'color' : 'green'}]},
];

self.buildAngleRanges = function () {
	function rangeLabel (name) {
		switch (name)
		{
			case SceneUtils.KnownAngles.ARM_FOREARM:
			return 'Elbow Angle';
			case SceneUtils.KnownAngles.HIP_KNEE_ANGLE:
			return 'Knee Angle Flexion';
			case SceneUtils.KnownAngles.KNEE_EXTENSION:
			return 'Knee Angle Extension';
			case SceneUtils.KnownAngles.ARM_PIT:
			return 'Shoulder Angle to Elbow';
			case SceneUtils.KnownAngles.BACK_ANGLE:
			return 'Back Angle';
		}
	}

	var bikeTypesList = $('#bikeTypesList');
	var bikeTypes = ['road', 'mtb', 'tri', 'tt'];
	var bikeTypeLables = ['Road', 'MTB', 'Triathlon', 'Time trial'];

	for (var i = 0; i < bikeTypes.length; i++) {
		var a = $('<a/>', {
			role : 'menuitem',
			value : bikeTypes[i],
			tabindex : '-1',
			href : '#',
			class : 'strong',
			text : bikeTypeLables[i]
		});

		var li = $('<li/>', {
			role : 'presentation'
		});

		li.append(a);
		bikeTypesList.append(li);

		for (var j = 0; j < self.ranges[bikeTypes[i]].length; j++) {
			var currRange = self.ranges[bikeTypes[i]][j]['ranges'][0]['range'];
			var label = rangeLabel(self.ranges[bikeTypes[i]][j]['name']);

			var li = $('<li/>', {
				role : 'presentation',
				class : 'dropdown-header unselectable',
				text : label + ': '
			});

			var span = $('<span/>', {
				class : 'strong',
				text : currRange[0] + ' ' + currRange[1]
			});

			li.append(span);
			bikeTypesList.append(li);
		}
	}

	$(".dropdown-menu li a").click(function(){
		console.log($(this).parents(".dropdown").find('.btn'));
		$(this).parents(".dropdown").find('.btn').html($(this).text()+" <span class=\"caret\"></span>");
		$(this).parents(".dropdown").find('.btn').val($(this).text());

		var bikeType = $(this).attr('value');	
		self.sceneTop.updateRanges(self.ranges[bikeType]);
	});

}();

self.getRange = function(type, angle) {
	var selectedRange = self.ranges[type];
	for (idx in selectedRange) {
		if (selectedRange[idx]['name'] == angle) {
			return selectedRange[idx]['ranges'];
		}
	}

	return [];
}

self.onAngleChanged = function(angle, target) {
			//console.log(angle + ' ' + target);
			$('#' + target).text(angle + '°');

			if (target == SceneUtils.KnownAngles.HIP_KNEE_ANGLE) {
				$('#' + SceneUtils.KnownAngles.KNEE_EXTENSION).text((180 - angle).toFixed(1) + '°');
			}
		}

		self.getToolIdFromName = function (target) {								
			var indexToolId = target.indexOf('_');

			if (indexToolId == -1)
				return '-1';

			return target.substring(indexToolId + 1, target.indexOf('_', indexToolId + 1));			
		}

		self.onCustomToolLineChanged = function(f, t, target) {
			for (var i = 0; i < self.customToolsList.length; i++) {
				target = self.customToolsList[i];
				var toolId = self.getToolIdFromName(target);

				var currLine = target + '0';
				$('.custom-tool-' + toolId).find('#' + currLine).text(self.pixelsToMM(self.sceneTop.getLine(currLine).length()));
				currLine = target + '1';
				$('.custom-tool-' + toolId).find('#' + currLine).text(self.pixelsToMM(self.sceneTop.getLine(currLine).length()));
			}				
		}

		self.updateBackAngle = function() {
			var hLine = self.sceneTop.getLine(SceneUtils.KnownLines.HORIZONTAL_REF_LINE);
			var bLine = self.sceneTop.getLine(SceneUtils.KnownLines.BACK_LINE);

			if (hLine == undefined || bLine == undefined)
				return;

			var angle = GeometryUtils.AngleBetweenLines(hLine, bLine);
			$('#backAngle').text((180 - angle).toFixed(1) + '°');
		}

		// Custom tool angle
		self.updateCustomAngle = function() {
			var hLine = self.sceneTop.getLine(SceneUtils.KnownLines.HORIZONTAL_REF_LINE);
			var bLine = self.sceneTop.getLine(SceneUtils.KnownLines.CUSTOM_LINE);

			if (hLine == undefined || bLine == undefined)
				return;

			var angle = GeometryUtils.AngleBetweenLines(hLine, bLine);
			$('#customAngle').text(Math.abs(180-angle).toFixed(1) + '°' + ' / ' +angle.toFixed(1) + '°');
		}

		self.getCMPerPixel = function () {
			if (self.refDistanceInPixels == 0)
				return 0;

			return self.refDistanceCM / self.refDistanceInPixels;
		}

		self.pixelsToMM = function(val) {			
			return (val * 10 * self.getCMPerPixel()).toFixed(1) + ' mm';
		}

		self.updateLineSizes = function() {						
			var thighLine = self.sceneTop.getLine(SceneUtils.KnownLines.THIGH_LINE);
			$('#thighLength').text(self.pixelsToMM(thighLine != undefined ? thighLine.length() : 0));

			var shinLine = self.sceneTop.getLine(SceneUtils.KnownLines.SHIN_LINE);
			$('#shinLength').text(self.pixelsToMM(shinLine != undefined ? shinLine.length() : 0));

			var hipToWrist = self.sceneTop.getLine(SceneUtils.KnownLines.HIP_TO_WRIST);
			$('#hipToWristH').text(self.pixelsToMM(hipToWrist != undefined ? hipToWrist.horizontalDistance() : 0));
			$('#hipToWristV').text(self.pixelsToMM(hipToWrist != undefined ? hipToWrist.verticalDistance() : 0));

			var customLine = self.sceneTop.getLine(SceneUtils.KnownLines.CUSTOM_LINE);
			$('#endToEndH').text(self.pixelsToMM(customLine != undefined ? customLine.horizontalDistance() : 0));
			$('#endToEndV').text(self.pixelsToMM(customLine != undefined ? customLine.verticalDistance() : 0));
			$('#customLength').text(self.pixelsToMM(customLine != undefined ? customLine.length() : 0));
		}	

		self.getNextLabel = function() {
			if (lastLabel >= letters.length) {
				alert('no more letters');
			}

			var label = letters[lastLabel];
			lastLabel += 1;

			return label;
		}

		self.reloadScene = function () {
			var canvasId = "stepOneCanvas";
			self.sceneTop.load(self.points[canvasId], self.lines[canvasId], self.angles[canvasId], self.texts[canvasId]);
		}

		self.setupCanvas = function(canvasId) {
			paper.setup(canvasId);		

			var getNextLabel = self.getNextLabel;
			var onAngleChanged = self.onAngleChanged;					

			self.points['stepOneCanvas'] = [
			{'x': 647, 'y' : 140, 'scale' : true, 'name' : SceneUtils.KnownPoints.SHOULDER, 'label' : getNextLabel()},
			{'x': 703, 'y' : 246, 'scale' : true, 'name' : SceneUtils.KnownPoints.ELBOW, 'label' : getNextLabel()},
			{'x': 794, 'y' : 291, 'scale' : true, 'name' : SceneUtils.KnownPoints.WRIST, 'label' : getNextLabel()},
			{'x': 476, 'y' : 261, 'scale' : true, 'name' : SceneUtils.KnownPoints.HIP, 'label' : getNextLabel()},
			{'x': 615, 'y' : 370, 'scale' : true, 'name' : SceneUtils.KnownPoints.KNEE, 'label' : getNextLabel()},
			{'x': 597, 'y' : 541, 'scale' : true, 'name' : SceneUtils.KnownPoints.ANKLE, 'label' : getNextLabel()},		

			{'x': 49,  'y' : 60, 'scale' : false, 'name' : SceneUtils.KnownPoints.LEN_REF_START, 'label' : getNextLabel()},
			{'x': 179, 'y' : 60, 'scale' : false, 'name' : SceneUtils.KnownPoints.LEN_REF_END, 'label' : getNextLabel()},

			{'x': 49, 'y' : 137, 'scale' : false, 'name' : SceneUtils.KnownPoints.HORIZ_REF_START, 'label' : getNextLabel()},
			{'x': 179, 'y' : 137, 'scale' : false, 'name' : SceneUtils.KnownPoints.HORIZ_REF_END, 'label' : getNextLabel()}
			];

			self.lines['stepOneCanvas'] = [
			{ 'name' : SceneUtils.KnownLines.ARM_LINE, 'points' : [SceneUtils.KnownPoints.SHOULDER, SceneUtils.KnownPoints.ELBOW]},
			{ 'name' : SceneUtils.KnownLines.FOREARM_LINE, 'points' : [SceneUtils.KnownPoints.ELBOW, SceneUtils.KnownPoints.WRIST]},
			{ 'name' : SceneUtils.KnownLines.THIGH_LINE, 'points' : [SceneUtils.KnownPoints.HIP, SceneUtils.KnownPoints.KNEE]},
			{ 'name' : SceneUtils.KnownLines.SHIN_LINE, 'points' : [SceneUtils.KnownPoints.KNEE, SceneUtils.KnownPoints.ANKLE]},
			{ 'name' : SceneUtils.KnownLines.BACK_LINE, 'points' : [SceneUtils.KnownPoints.HIP, SceneUtils.KnownPoints.SHOULDER]},

			{ 'name' : SceneUtils.KnownLines.HIP_TO_WRIST, 'points' : [SceneUtils.KnownPoints.HIP, SceneUtils.KnownPoints.WRIST], 'visible' : false},

			{ 'name' : SceneUtils.KnownLines.DISTANCE_REF_LINE, 'points' : [SceneUtils.KnownPoints.LEN_REF_START, SceneUtils.KnownPoints.LEN_REF_END]},
			{ 'name' : SceneUtils.KnownLines.HORIZONTAL_REF_LINE, 'points' : [SceneUtils.KnownPoints.HORIZ_REF_START, SceneUtils.KnownPoints.HORIZ_REF_END]},
			];

			self.angles['stepOneCanvas'] = [
			{ 'name': SceneUtils.KnownAngles.ARM_FOREARM, 'side_first' : SceneUtils.KnownLines.ARM_LINE, 'side_second' : SceneUtils.KnownLines.FOREARM_LINE, 'ranges' : self.getRange('road', SceneUtils.KnownAngles.ARM_FOREARM), 'onAngleChanged' : onAngleChanged},
			{ 'name': SceneUtils.KnownAngles.HIP_KNEE_ANGLE, 'side_first' : SceneUtils.KnownLines.THIGH_LINE, 'side_second' : SceneUtils.KnownLines.SHIN_LINE, 'ranges' : self.getRange('road', SceneUtils.KnownAngles.HIP_KNEE_ANGLE), 'onAngleChanged' : onAngleChanged},
			{ 'name': SceneUtils.KnownAngles.KNEE_EXTENSION, 'side_first' : SceneUtils.KnownLines.THIGH_LINE, 'side_second' : SceneUtils.KnownLines.BACK_LINE, 'ranges' : self.getRange('road', SceneUtils.KnownAngles.KNEE_EXTENSION), 'onAngleChanged' : onAngleChanged},
			{ 'name': SceneUtils.KnownAngles.HIP_OPEN, 'side_first' : SceneUtils.KnownLines.THIGH_LINE, 'side_second' : SceneUtils.KnownLines.BACK_LINE, 'onAngleChanged' : onAngleChanged},
			{ 'name': SceneUtils.KnownAngles.ARM_PIT, 'side_first' : SceneUtils.KnownLines.BACK_LINE, 'side_second' : SceneUtils.KnownLines.ARM_LINE, 'ranges' : self.getRange('road', SceneUtils.KnownAngles.ARM_PIT), 'onAngleChanged' : onAngleChanged},
			{ 'name': SceneUtils.KnownAngles.BACK_ANGLE, 'side_first' : SceneUtils.KnownLines.BACK_LINE, 'side_second' : SceneUtils.KnownLines.HORIZONTAL_REF_LINE, 'ranges' : self.getRange('road', SceneUtils.KnownAngles.BACK_ANGLE), 'onAngleChanged' : onAngleChanged},
			];

			self.texts['stepOneCanvas'] = [
			{ 'name' : 'HORIZONTAL_REF_LINE', text : 'Length reference', 'x' : 42, 'y' : 40},
			{ 'name' : 'HORIZONTAL_REF_LINE', text : 'Horizontal reference', 'x' : 42, 'y' : 120},				
			]

			var scene = new Scene(canvasId, $('.stepCanvasArea').width(), $('.stepCanvasArea').height());
			scene.load(self.points[canvasId], self.lines[canvasId], self.angles[canvasId], self.texts[canvasId]);

			view.onFrame = function (event) {
				scene.animateJoints(event);
			}

			return scene;
		}

		self.sceneTop = self.setupCanvas('stepOneCanvas');				

		[self.sceneTop].forEach(function (scene) {			
			// Thigh line
			scene.onLineLengthChanged(function (f, t) {	
				self.updateLineSizes();
			}, SceneUtils.KnownLines.THIGH_LINE);

			// Shin line
			scene.onLineLengthChanged(function (f, t) {			
				self.updateLineSizes();
			}, SceneUtils.KnownLines.SHIN_LINE);

			// Hip to wrist
			scene.onLineLengthChanged(function (f, t) {
				self.updateLineSizes();
			}, SceneUtils.KnownLines.HIP_TO_WRIST);
			
			// Ref length line
			scene.onLineLengthChanged(function (from, to) {
				self.refDistanceInPixels = from.getDistance(to);
				self.updateLineSizes();		
			}, SceneUtils.KnownLines.DISTANCE_REF_LINE);

			// Custom tool
			scene.onLineLengthChanged(function (f, t) {
				self.updateLineSizes();
				updateCustomAngle();
			}, SceneUtils.KnownLines.CUSTOM_LINE);

			// Back line
			scene.onLineLengthChanged(function (f, t) {
				self.updateBackAngle();
			}, SceneUtils.KnownLines.BACK_LINE);	

			scene.onLineLengthChanged(function (f, t) {
				self.updateBackAngle();
			}, SceneUtils.KnownLines.HORIZONTAL_REF_LINE);	
		});	

$($('.stepCanvasArea')[1]).hide();	
});

</script>

</body>
</html>
