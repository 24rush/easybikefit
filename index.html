<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Easy road bike fitting</title>
	
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">		
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">	
	<link href="css/style.css" rel='stylesheet' type='text/css' />	
</head>
<body>			
	<div class="container-fluid">		
		<div class="row">
			<div class="col-md-2">
				<div class="panel panel-default">
					<div class="panel-heading">Angles</div>
					<div class="panel-body">
						<span>Hip - Knee </span><span class="angleText" id="hipKneeAngle"></span>
						<br>
						<span>Elbow Angle </span><span class="angleText" id="elbowAngle"></span>
						<br>
						<span>Knee Angle Extension </span><span class="angleText" id="kneeAngleExtension"></span>
						<br>
						<span>Hip Angle Open </span><span class="angleText" id="hipAngleOpen"></span>
						<br>
						<span>Shoulder Angle to Elbow </span><span class="angleText" id="shoulderElbowAngle"></span>
						<br>
						<div class="alert alert-note alert-small" role="alert" style="margin-top: 5px;">
							<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
							<span class="sr-only">Note:</span>
							Adjust I and J points to represent a horizontal reference line for correct back angle
						</div>						
						<span>Back Angle </span><span class="angleText" id="backAngle"></span>
					</div>
				</div>

				<div class="panel panel-default">
					<div class="panel-heading">Lengths</div>
					<div class="panel-body">	
						<div id="alertLength" class="alert alert-note alert-small" role="alert">
							<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
							<span class="sr-only">Note:</span>
							Enter distance reference to get stats
						</div>

						<span>Length reference distance </span><input type="text" class="form-control" id="inputLength" style="width: 50px;display: inline;" placeholder="cm">			
						<br>
						<span>Thigh Length </span><span class="angleText" id="thighLength"></span>
						<br>
						<span>Shin Length </span><span class="angleText" id="shinLength"></span>
						<br>
						<span>Hip to wrist (horiz) </span><span class="angleText" id="hipToWristH"></span>
						<br>
						<span>Hip to wrist (vertical) </span><span class="angleText" id="hipToWristV"></span>
					</div>
				</div>

				<div class="panel panel-default">
					<div class="panel-heading">Custom</div>
					<div class="panel-body">		
						<div class="alert alert-note alert-small" role="alert">
							<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
							<span class="sr-only">Note:</span>
							Move K and L points to perform custom measurements
						</div>				
						<span>Length </span><span class="angleText" id="customLength"></span>
						<br>
						<span>Angle horizontal </span><span class="angleText" id="customAngle"></span>
						<br>
						<span>End to end length (horiz) </span><span class="angleText" id="endToEndH"></span>
						<br>
						<span>End to end (vertical) </span><span class="angleText" id="endToEndV"></span>
					</div>
				</div>
			</div>

			<div class="col-md-8">
				<div class="stepWorkArea">
					<div class="stepHeader alert alert-header unselectable" role="alert">
						<span id="stepOneDropdownIco" class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span>				
						<b>Step 1 </b>| Side picture with leg straight (cranks at 6 and 12 o'clock)
						<span class="btn btn-default btn-file" style="margin-left: 10px;">
							Upload a picture of you<input type="file" id="fileOne" class="clickable">
						</span>
					</div>		
					<div class="stepCanvasArea" style="width: 100%; height: 100%; pointer-events: none;background-color: #E5FFF7; background-repeat: no-repeat; background-position: center;background-image: url(http://www.triradar.com/files/2014/01/DIY-Bike-Fit.jpg); background-size: contain;">
						<canvas id="stepOneCanvas" style="pointer-events: all; width: 100%; height: 100%;"></canvas>
					</div>		
				</div>

				<div class="stepWorkArea" style="margin-top: 5px;">
					<div class="stepHeader alert alert-header unselectable" role="alert">
						<span id="stepOneDropdownIco" class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>				
						<b>Step 2 </b>| Side picture with knee bent (cranks at 3 and 9 o'clock)
						<span class="btn btn-default btn-file" style="margin-left: 10px;">
							Upload a picture of you<input type="file" id="fileTwo" class="clickable">
						</span>
					</div>		
					<div class="stepCanvasArea" style="width:100%; height: 100%; pointer-events: none;background-color: #E5FFF7; background-repeat: no-repeat; background-position: center;background-image: url(http://www.triradar.com/files/2014/01/DIY-Bike-Fit.jpg); background-size: contain;">
						<canvas id="stepTwoCanvas" style="pointer-events: all; width: 100%; height: 100%;"></canvas>
					</div>		
				</div>
			</div>
		</div>
	</div>
	<!--button type="button" class="btn btn-default" id="btnDump">Dump</button-->

	<script src="js/lib/jquery.min.js" type="text/javascript"></script>		
	<script src="js/lib/bootstrap.min.js" type="text/javascript"></script>	
	<script src="js/paper-full.js" type="text/javascript"></script>
	<script src="js/paper-core.js" type="text/javascript"></script>

	<script src="js/jointpoint.js" type="text/javascript"></script>
	<script src="js/line.js" type="text/javascript"></script>
	<script src="js/text.js" type="text/javascript"></script>
	<script src="js/jointsangle.js" type="text/javascript"></script>	
	<script src="js/dependentpoint.js" type="text/javascript"></script>
	<script src="js/scene.js" type="text/javascript"></script>
	<script src="js/vectorutils.js" type="text/javascript"></script>

	<script type="text/javascript">
	$(document).on('change', '.btn-file :file', function(evt) {	
		var input = $(this),
		numFiles = input.get(0).files ? input.get(0).files[0] : 1;
		input.trigger('fileselect', [numFiles, evt.target.id]);
	});

	$(document).ready(function() {		
		$('.btn-file :file').on('fileselect', function(event, numFiles, targetId) {
			var file = new FileReader();			
			file.readAsDataURL(event.target.files[0]);

			file.onload = function(evt) {	
				var destination = $(targetId == 'fileOne' ? $('.stepCanvasArea')[0] : $('.stepCanvasArea')[1]);
				destination.css('background-image', 'url("' + evt.target.result + '")');
				loadToolbox();
			}		
		});

		$('.stepHeader').click(function(event) {			
			if (event.target.localName == 'input')
				return;

			$.each($('.stepHeader'), function (index, step) {
				var menuIco = $(step).find('#stepOneDropdownIco');			
				//Close
				if (menuIco.hasClass('glyphicon-chevron-down') == true) {
					menuIco.removeClass('glyphicon-chevron-down');
					menuIco.addClass('glyphicon-chevron-right');

					$($(this).siblings()[0]).animate({ height: "toggle", opacity: 0 }, 500, function() {
						$($(step).siblings()[0]).css('opacity', '0');
					});  

				} else { // Open
					menuIco.addClass('glyphicon-chevron-down');
					menuIco.removeClass('glyphicon-chevron-right');

					$($(this).siblings()[0]).animate({ height: "toggle", opacity: 1 }, 500, function() {
						$($(step).siblings()[0]).css('opacity', '1');
					});					
				}
			});
		});

		var self = this;
		var wWidth = $('#stepOneCanvas').width();		

		paper.install(window);			

		var windowHeight = 0.8 * $(window).height();
		$('.stepCanvasArea').height(windowHeight);	

		var inputLength = $('#inputLength');
		var refDistanceCM = 0;
		var refDistanceInPixels = 0;
		var refDistanceCMPerPixel  = 0;		

		inputLength.data('oldVal', inputLength.val());
		inputLength.bind("propertychange change click keyup input paste", function(e) {
			if (inputLength.val() == '') {
				$('#alertLength').fadeIn();
				return;
			}				

			if (inputLength.data('oldVal') != inputLength.val()) {
				$('#alertLength').fadeOut();

				inputLength.data('oldVal', inputLength.val());
				refDistanceCM = inputLength.val() != '' ? inputLength.val() : 0;
				refDistanceCMPerPixel  = refDistanceCM / refDistanceInPixels;

				updateLineSizes();
			}
		});

		inputLength.keydown(function(event) {                
			if (event.keyCode == 46 || event.keyCode == 8 || event.keyCode == 9 
				|| event.keyCode == 27 || event.keyCode == 13 
				|| (event.keyCode == 65 && event.ctrlKey === true) 
				|| (event.keyCode >= 35 && event.keyCode <= 39))
				return;		

			if (event.shiftKey || (event.keyCode < 48 || event.keyCode > 57) && (event.keyCode < 96 || event.keyCode > 105 )) {
				event.preventDefault(); 
			}   
		});

		function setupCanvas(canvasId) {
			paper.setup(canvasId);

			var scene = new Scene(canvasId, $('.stepCanvasArea').width(), $('.stepCanvasArea').height());
			scene.loadToolbox();

			view.onFrame = function (event) {
				scene.animateJoints(event);
			}

			return scene;
		}

		var sceneTop = setupCanvas('stepOneCanvas');

		// Thigh line
		sceneTop.onLineLengthChanged(function (f, t) {			
			updateLineSizes();
		}, SceneUtils.KnownLines.THIGH_LINE);

		// Shin line
		sceneTop.onLineLengthChanged(function (f, t) {			
			updateLineSizes();
		}, SceneUtils.KnownLines.SHIN_LINE);

		// Hip to wrist
		sceneTop.onLineLengthChanged(function (f, t) {
			updateLineSizes();
		}, SceneUtils.KnownLines.HIP_TO_WRIST);

		var sceneBottom = setupCanvas('stepTwoCanvas');

		// Ref length line
		sceneTop.onLineLengthChanged(function (from, to) {
			refDistanceInPixels = from.getDistance(to);
			updateLineSizes();		
		}, SceneUtils.KnownLines.DISTANCE_REF_LINE);

		// Custom tool
		sceneTop.onLineLengthChanged(function (f, t) {
			updateLineSizes();
			updateCustomAngle();
		}, SceneUtils.KnownLines.CUSTOM_LINE);

		// Back line
		function updateBackAngle() {
			var hLine = sceneTop.getLine(SceneUtils.KnownLines.HORIZONTAL_REF_LINE);
			var bLine = sceneTop.getLine(SceneUtils.KnownLines.BACK_LINE);

			if (hLine == undefined || bLine == undefined)
				return;

			var angle = GeometryUtils.AngleBetweenLines(hLine, bLine);
			$('#backAngle').text(angle.toFixed(1) + '°');
		}

		// Custom tool angle
		function updateCustomAngle() {
			var hLine = sceneTop.getLine(SceneUtils.KnownLines.HORIZONTAL_REF_LINE);
			var bLine = sceneTop.getLine(SceneUtils.KnownLines.CUSTOM_LINE);

			if (hLine == undefined || bLine == undefined)
				return;

			var angle = GeometryUtils.AngleBetweenLines(hLine, bLine);
			$('#customAngle').text(Math.abs(180-angle).toFixed(1) + '°' + ' / ' +angle.toFixed(1) + '°');
		}

		sceneTop.onLineLengthChanged(function (f, t) {
			updateBackAngle();
		}, SceneUtils.KnownLines.BACK_LINE);	

		sceneTop.onLineLengthChanged(function (f, t) {
			updateBackAngle();
		}, SceneUtils.KnownLines.HORIZONTAL_REF_LINE);	
		
		function updateLineSizes() {
			function centiMeterstoMeters(val) {
				return (val * 10).toFixed(1) + ' mm';
			}

			refDistanceCMPerPixel = refDistanceCM / refDistanceInPixels;
			var thighLine = sceneTop.getLine(SceneUtils.KnownLines.THIGH_LINE);
			$('#thighLength').text(centiMeterstoMeters(thighLine != undefined ? (thighLine.length() * refDistanceCMPerPixel) : 0));

			var shinLine = sceneTop.getLine(SceneUtils.KnownLines.SHIN_LINE);
			$('#shinLength').text(centiMeterstoMeters(shinLine != undefined ? (shinLine.length() * refDistanceCMPerPixel) : 0));

			var hipToWrist = sceneTop.getLine(SceneUtils.KnownLines.HIP_TO_WRIST);
			$('#hipToWristH').text(centiMeterstoMeters(hipToWrist != undefined ? (hipToWrist.horizontalDistance() * refDistanceCMPerPixel) : 0));
			$('#hipToWristV').text(centiMeterstoMeters(hipToWrist != undefined ? (hipToWrist.verticalDistance() * refDistanceCMPerPixel) : 0));

			var customLine = sceneTop.getLine(SceneUtils.KnownLines.CUSTOM_LINE);
			$('#endToEndH').text(centiMeterstoMeters(customLine != undefined ? (customLine.horizontalDistance() * refDistanceCMPerPixel) : 0));
			$('#endToEndV').text(centiMeterstoMeters(customLine != undefined ? (customLine.verticalDistance() * refDistanceCMPerPixel) : 0));
			$('#customLength').text(centiMeterstoMeters(customLine != undefined ? (customLine.length() * refDistanceCMPerPixel) : 0));
		}

		$($('.stepCanvasArea')[1]).hide();	
	});

</script>

</body>
</html>
